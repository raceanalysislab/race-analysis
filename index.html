<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#f3f4f6" />
  <title>本日の開催一覧</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header class="top">
    <div class="top__row">
      <h1 class="top__title">本日の開催一覧</h1>

      <!-- ✅ 右側：PRO → 更新（順番固定） -->
      <div class="top__actions">
        <button id="btnPro" class="top__pro" type="button" aria-pressed="false">
          <span class="top__proDot" aria-hidden="true"></span>
          <span>PRO</span>
        </button>
        <button id="btnRefresh" class="top__btn" type="button">更新</button>
      </div>
    </div>

    <div class="top__sub">
      <div class="top__pull">↓ 引っ張って更新</div>
      <div class="top__updated">最終更新: <span id="updatedAt">--:--</span></div>
    </div>
  </header>

  <main class="wrap">
    <section class="gridWrap" aria-label="会場一覧">
      <section id="grid" class="grid"></section>
    </section>

    <!-- ✅ 本日厳選レース（見出しは1つだけ） -->
    <section class="picksWrap" aria-label="本日厳選レース">
      <div class="picksHead">
        <h2 class="picksTitle">本日厳選レース</h2>
        <div class="picksMeta">更新: <span id="picksUpdatedAt">--:--</span></div>
      </div>

      <!-- ✅ CTAは見出し直下に固定（常時表示） -->
      <div id="picksCta" class="picksCta"></div>

      <!-- ✅ picksがある日だけ下に出る（空の説明は出さない） -->
      <div id="picks" class="picksList"></div>
    </section>
  </main>

  <script>
    // ====== 固定順（公式アプリ順） ======
    const VENUES = [
      { jcd: "01", name: "桐生" }, { jcd: "02", name: "戸田" }, { jcd: "03", name: "江戸川" }, { jcd: "04", name: "平和島" },
      { jcd: "05", name: "多摩川" }, { jcd: "06", name: "浜名湖" }, { jcd: "07", name: "蒲郡" }, { jcd: "08", name: "常滑" },
      { jcd: "09", name: "津" }, { jcd: "10", name: "三国" }, { jcd: "11", name: "びわこ" }, { jcd: "12", name: "住之江" },
      { jcd: "13", name: "尼崎" }, { jcd: "14", name: "鳴門" }, { jcd: "15", name: "丸亀" }, { jcd: "16", name: "児島" },
      { jcd: "17", name: "宮島" }, { jcd: "18", name: "徳山" }, { jcd: "19", name: "下関" }, { jcd: "20", name: "若松" },
      { jcd: "21", name: "芦屋" }, { jcd: "22", name: "福岡" }, { jcd: "23", name: "唐津" }, { jcd: "24", name: "大村" },
    ];

    const $grid = document.getElementById("grid");
    const $updatedAt = document.getElementById("updatedAt");
    const $btn = document.getElementById("btnRefresh");

    const $picks = document.getElementById("picks");
    const $picksUpdatedAt = document.getElementById("picksUpdatedAt");
    const $picksCta = document.getElementById("picksCta");

    const $btnPro = document.getElementById("btnPro");

    const pad2 = (n) => String(n).padStart(2, "0");
    const toHM = (s) => (typeof s === "string" && s.length >= 4) ? s.slice(0,5) : "--:--";

    // ✅ 「2 日目」みたいな余計な空白を消して「2日目」にする
    const normalizeJP = (s) => String(s || "").replace(/\s+/g, "");

    // ✅ gradeの表記ブレを吸収して SG/G1/G2/G3 だけ通す（それ以外は一般）
    function normalizeGrade(raw){
      let s = String(raw || "").trim();

      // 全角→半角寄せ（Ｇ１など）
      s = s.replace(/[Ａ-Ｚａ-ｚ０-９]/g, ch =>
        String.fromCharCode(ch.charCodeAt(0) - 0xFEE0)
      );

      s = s.toUpperCase();
      s = s.replace(/\s+/g, "");

      // ローマ数字等のブレ吸収（GⅠ, GI など）
      s = s.replace("GⅠ", "G1").replace("GI", "G1");
      s = s.replace("GⅡ", "G2").replace("GII", "G2");
      s = s.replace("GⅢ", "G3").replace("GIII", "G3");

      // 末尾に変な記号がつくケースを削る（例: "G1,"）
      s = s.replace(/[^A-Z0-9]/g, "");

      if (s === "SG" || s === "G1" || s === "G2" || s === "G3") return s;
      return ""; // 記念じゃない扱い
    }

    function gradeLabel(v){
      if (!v.held) return "";
      const g = normalizeGrade(v.grade);
      return g ? g : "一般";
    }

    function dayLabel(v){
      if (!v.held) return "";
      if (typeof v.day === "number") return `${v.day}日目`;
      if (typeof v.day === "string" && v.day.trim()) return normalizeJP(v.day.trim());
      return "—";
    }

    function raceTimeLine(v){
      if (!v.held) return "-- --";
      if (v.race && v.time) return `${String(v.race)} ${toHM(String(v.time))}`;
      if (v.next_r && v.close_at) return `${String(v.next_r)}R ${toHM(String(v.close_at))}`;
      return "-- --";
    }

    function cardHTML(v){
      const held = !!v.held;
      const href = held && v.url ? v.url : "#";
      const cls = held ? "card card--on" : "card card--off";

      const mid = held ? `${gradeLabel(v)} ${dayLabel(v)}` : "-- --";
      const btm = raceTimeLine(v);

      return `
        <a class="${cls}" href="${href}" ${held ? "" : 'aria-disabled="true" onclick="return false;"'}>
          <div class="card__name">${v.name}</div>
          <div class="card__line card__line--mid">${mid}</div>
          <div class="card__line card__line--btm">${btm}</div>
        </a>
      `;
    }

    // ✅ 追加：開催判定（blocked でも bytes で判定する）
    function inferHeld(v){
      if (v && v.held === true) return true;

      const sc = Number(v?.status_code || 0);
      const bytes = Number(v?.bytes || 0);

      if (sc === 200 && bytes >= 20000) return true;
      return false;
    }

    // ✅ デモ用：強制的にONにする会場（本番は [] にするだけ）
    const DEBUG_FORCE_ON = ["03", "12", "19"]; // 江戸川 / 住之江 / 下関

    function render(data){
      const map = new Map();
      (data.venues || []).forEach(v => map.set(v.jcd, v));

      const merged = VENUES.map(base => {
        const v = map.get(base.jcd) || {};

        // ✅ ここだけ差分：データでON or デモ強制ON
        const held = inferHeld(v) || DEBUG_FORCE_ON.includes(base.jcd);

        return {
          jcd: base.jcd,
          name: base.name,
          url: v.url || "",
          held: held,
          grade: v.grade,
          day: v.day,
          race: v.race,
          time: v.time,
          next_r: v.next_r,
          close_at: v.close_at,

          status_code: v.status_code,
          bytes: v.bytes,
          note: v.note
        };
      });

      $grid.innerHTML = merged.map(cardHTML).join("");

      if (data.time) {
        const t = String(data.time);
        const hm = t.includes(" ") ? t.split(" ")[1].slice(0,5) : "--:--";
        $updatedAt.textContent = hm;
      } else {
        const now = new Date();
        $updatedAt.textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
      }
    }

    // ====== picks_today.json ======
    function gradeBadgeClass(g){
      const ng = normalizeGrade(g);
      if (ng === "SG") return "badge badge--sg";
      if (ng === "G1") return "badge badge--g1";
      if (ng === "G2") return "badge badge--g2";
      if (ng === "G3") return "badge badge--g3";
      return "badge badge--ippan";
    }

    function pickCardHTML(p){
      const venue = p.venue || (p.jcd ? (VENUES.find(v => v.jcd === p.jcd)?.name || "") : "");
      const race = p.race ? String(p.race) : "";
      const tm = p.time ? toHM(String(p.time)) : "--:--";
      const title = p.title ? String(p.title) : "厳選";
      const g = p.grade ? String(p.grade) : "一般";
      const note = p.note ? String(p.note) : "";
      const href = p.url ? String(p.url) : "#";
      const clickable = !!p.url;

      return `
        <a class="pickCard" href="${href}" ${clickable ? "" : 'aria-disabled="true" onclick="return false;"'}>
          <div class="pickTop">
            <div class="pickName">${venue} ${race} <span style="opacity:.7;font-weight:700">／ ${title}</span></div>
            <div class="pickTime">${tm}</div>
          </div>
          <div class="pickSub">
            <span class="${gradeBadgeClass(g)}">${normalizeGrade(g) || "一般"}</span>
            ${p.tag ? `<span class="badge">${String(p.tag)}</span>` : ""}
          </div>
          ${note ? `<p class="pickNote">${note}</p>` : ``}
        </a>
      `;
    }

    function renderPicks(data){
      const picks = Array.isArray(data?.picks) ? data.picks : [];

      if (!picks.length){
        $picks.innerHTML = "";
      } else {
        $picks.innerHTML = picks.map(pickCardHTML).join("");
      }

      if (data?.time) {
        const t = String(data.time);
        const hm = t.includes(" ") ? t.split(" ")[1].slice(0,5) : "--:--";
        $picksUpdatedAt.textContent = hm;
      } else {
        const now = new Date();
        $picksUpdatedAt.textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
      }
    }

    // ====== ✅ CTA（FREEは3つ / PROは別枠） ======
    const URL_YOSO_ONLY = "https://note.com/wsnndboat7/n/n1fdca8b0a7e3";
    const URL_PRO_ONLY  = "https://note.com/wsnndboat7/n/n8d805a4f27bf";
    const URL_SET       = "https://note.com/wsnndboat7/n/n6fcdb2a9db4f";

    function renderPicksCta(){
      const isPro = document.documentElement.getAttribute("data-theme") === "pro";

      if (!isPro){
        $picksCta.innerHTML = `
          <a class="picksBtn" href="${URL_YOSO_ONLY}" target="_blank" rel="noopener noreferrer">
            <div>
              <div>予想だけ購入（500円）</div>
              <div class="picksBtnSub">noteで確認</div>
            </div>
            <div class="picksBtnArrow">→</div>
          </a>

          <a class="picksBtn" href="${URL_PRO_ONLY}" target="_blank" rel="noopener noreferrer">
            <div>
              <div>PROだけ購入（500円）</div>
              <div class="picksBtnSub">キー配布方式（購読者＝PRO扱い）</div>
            </div>
            <div class="picksBtnArrow">→</div>
          </a>

          <a class="picksBtn picksBtn--set" href="${URL_SET}" target="_blank" rel="noopener noreferrer">
            <div>
              <div>セット購入（800円）</div>
              <div class="picksBtnSub">予想 + PRO（お得）</div>
            </div>
            <div class="picksBtnArrow">→</div>
          </a>
        `;
        return;
      }

      $picksCta.innerHTML = `
        <a class="picksBtn" href="#" aria-disabled="true" onclick="return false;">
          <div>
            <div>本日の注目選手（PRO）</div>
            <div class="picksBtnSub">ここは後で差し替え</div>
          </div>
          <div class="picksBtnArrow">—</div>
        </a>

        <a class="picksBtn" href="#" aria-disabled="true" onclick="return false;">
          <div>
            <div>本日の注目機（PRO）</div>
            <div class="picksBtnSub">ここは後で差し替え</div>
          </div>
          <div class="picksBtnArrow">—</div>
        </a>
      `;
    }

    // ✅ 24会場を「画面内に収める」高さ計算（グリッド比率は固定のまま）
    function setGridHeight(){
      const root = document.documentElement;
      const vv = window.visualViewport;
      const vh = vv ? vv.height : window.innerHeight;

      const header = document.querySelector(".top");
      const headerH = header ? header.getBoundingClientRect().height : 0;

      const margin = 18;
      const bottomReserve = 110;

      const gridH = Math.max(360, Math.floor(vh - headerH - margin - bottomReserve));
      root.style.setProperty("--gridH", `${gridH}px`);
    }

    // ====== 更新（重複防止 + キャッシュバスター） ======
    let isLoading = false;

    async function fetchJSON(path, force){
      const bust = force ? `?t=${Date.now()}` : "";
      const url = `${path}${bust}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`failed to fetch: ${path}`);
      return await res.json();
    }

    async function loadAll(force){
      if (isLoading) return;
      isLoading = true;
      try{
        const venuesData = await fetchJSON("./data/venues_today.json", force);
        render(venuesData);

        try{
          const picksData = await fetchJSON("./data/picks_today.json", force);
          renderPicks(picksData);
        }catch(e){
          renderPicks({ time: null, picks: [] });
        }

        renderPicksCta();
        setGridHeight();
      }finally{
        isLoading = false;
      }
    }

    $btn.addEventListener("click", () => {
      $btn.classList.add("is-loading");
      loadAll(true).catch(()=>{}).finally(()=> $btn.classList.remove("is-loading"));
    });

    // pull-to-refresh（簡易）
    let startY = 0;
    let pulling = false;

    window.addEventListener("touchstart", (e) => {
      if (window.scrollY <= 0) { startY = e.touches[0].clientY; pulling = true; }
    }, { passive: true });

    window.addEventListener("touchmove", (e) => {
      if (!pulling) return;
      const dy = e.touches[0].clientY - startY;
      if (dy > 80) { pulling = false; $btn.click(); }
    }, { passive: true });

    window.addEventListener("touchend", () => { pulling = false; }, { passive: true });

    // viewport変化にも追従
    window.addEventListener("resize", setGridHeight);
    if (window.visualViewport) window.visualViewport.addEventListener("resize", setGridHeight);

    // ✅ 5分ごとの自動更新（表示中だけ）
    const AUTO_MS = 5 * 60 * 1000;
    setInterval(() => {
      if (document.visibilityState === "visible") loadAll(true).catch(()=>{});
    }, AUTO_MS);

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") loadAll(true).catch(()=>{});
    });

    // ====== ✅ PRO 解放（1日固定 / data/pro_key.json を照合） ======
    const LS_THEME = "theme";
    const LS_PRO_OK_DATE = "pro_ok_date";

    function isProNow(){
      return document.documentElement.getAttribute("data-theme") === "pro";
    }

    function setTheme(isPro){
      const html = document.documentElement;
      if (isPro){
        html.setAttribute("data-theme","pro");
        localStorage.setItem(LS_THEME,"pro");
        $btnPro.setAttribute("aria-pressed","true");
      }else{
        html.removeAttribute("data-theme"); // FREE
        localStorage.setItem(LS_THEME,"free");
        $btnPro.setAttribute("aria-pressed","false");
      }
      renderPicksCta();
      setGridHeight();
    }

    async function getProKey(){
      return await fetchJSON("./data/pro_key.json", true);
    }

    async function bootProByStoredDate(){
      const savedTheme = localStorage.getItem(LS_THEME);
      const savedOkDate = localStorage.getItem(LS_PRO_OK_DATE);

      if (savedTheme !== "pro" || !savedOkDate){
        setTheme(false);
        return;
      }

      try{
        const pk = await getProKey();
        if (String(pk?.date || "") === String(savedOkDate)){
          setTheme(true);
        }else{
          localStorage.removeItem(LS_PRO_OK_DATE);
          setTheme(false);
        }
      }catch(e){
        setTheme(false);
      }
    }

    async function unlockProFlow(){
      if (isProNow()){
        setTheme(false);
        return;
      }

      let pk;
      try{
        pk = await getProKey();
      }catch(e){
        alert("PROキーの取得に失敗しました。通信状況を確認して、もう一度お試しください。");
        return;
      }

      const input = prompt("PROキー（6桁）を入力");
      if (input === null) return;

      const key = String(input).replace(/\s+/g,"");
      if (!/^\d{6}$/.test(key)){
        alert("6桁の数字で入力してください。");
        return;
      }

      if (String(pk?.key || "") === key){
        localStorage.setItem(LS_PRO_OK_DATE, String(pk.date || ""));
        setTheme(true);
        alert("PROを解放しました。");
      }else{
        alert("キーが違います。");
      }
    }

    $btnPro.addEventListener("click", () => {
      unlockProFlow().catch(()=>{});
    });

    bootProByStoredDate().catch(()=> setTheme(false));

    // 初回
    loadAll(false).catch(()=>{ renderPicksCta(); setGridHeight(); });
  </script>
</body>
</html>