<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#f3f4f6" />
  <title>æœ¬æ—¥ã®é–‹å‚¬ä¸€è¦§</title>
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header class="top">
    <div class="top__row">
      <h1 class="top__title">æœ¬æ—¥ã®é–‹å‚¬ä¸€è¦§</h1>

      <!-- âœ… å³å´ï¼šPRO â†’ æ›´æ–°ï¼ˆé †ç•ªå›ºå®šï¼‰ -->
      <div class="top__actions">
        <button id="btnPro" class="top__pro" type="button" aria-pressed="false">
          <span class="top__proDot" aria-hidden="true"></span>
          <span>PRO</span>
        </button>
        <button id="btnRefresh" class="top__btn" type="button">æ›´æ–°</button>
      </div>
    </div>

    <div class="top__sub">
      <div class="top__pull">â†“ å¼•ã£å¼µã£ã¦æ›´æ–°</div>
      <div class="top__updated">æœ€çµ‚æ›´æ–°: <span id="updatedAt">--:--</span></div>
    </div>
  </header>

  <main class="wrap">
    <section class="gridWrap" aria-label="ä¼šå ´ä¸€è¦§">
      <section id="grid" class="grid"></section>
    </section>

    <!-- âœ… æœ¬æ—¥å³é¸ãƒ¬ãƒ¼ã‚¹ï¼ˆè¦‹å‡ºã—ã¯1ã¤ã ã‘ï¼‰ -->
    <section class="picksWrap" aria-label="æœ¬æ—¥å³é¸ãƒ¬ãƒ¼ã‚¹">
      <div class="picksHead">
        <h2 class="picksTitle">æœ¬æ—¥å³é¸ãƒ¬ãƒ¼ã‚¹</h2>
        <div class="picksMeta">æ›´æ–°: <span id="picksUpdatedAt">--:--</span></div>
      </div>

      <!-- âœ… CTAã¯è¦‹å‡ºã—ç›´ä¸‹ã«å›ºå®šï¼ˆå¸¸æ™‚è¡¨ç¤ºï¼‰ -->
      <div id="picksCta" class="picksCta"></div>

      <!-- âœ… picksãŒã‚ã‚‹æ—¥ã ã‘ä¸‹ã«å‡ºã‚‹ï¼ˆç©ºã®èª¬æ˜ã¯å‡ºã•ãªã„ï¼‰ -->
      <div id="picks" class="picksList"></div>
    </section>
  </main>

  <script>
    // ====== å›ºå®šé †ï¼ˆå…¬å¼ã‚¢ãƒ—ãƒªé †ï¼‰ ======
    const VENUES = [
      { jcd: "01", name: "æ¡ç”Ÿ" }, { jcd: "02", name: "æˆ¸ç”°" }, { jcd: "03", name: "æ±Ÿæˆ¸å·" }, { jcd: "04", name: "å¹³å’Œå³¶" },
      { jcd: "05", name: "å¤šæ‘©å·" }, { jcd: "06", name: "æµœåæ¹–" }, { jcd: "07", name: "è’²éƒ¡" }, { jcd: "08", name: "å¸¸æ»‘" },
      { jcd: "09", name: "æ´¥" }, { jcd: "10", name: "ä¸‰å›½" }, { jcd: "11", name: "ã³ã‚ã“" }, { jcd: "12", name: "ä½ä¹‹æ±Ÿ" },
      { jcd: "13", name: "å°¼å´" }, { jcd: "14", name: "é³´é–€" }, { jcd: "15", name: "ä¸¸äº€" }, { jcd: "16", name: "å…å³¶" },
      { jcd: "17", name: "å®®å³¶" }, { jcd: "18", name: "å¾³å±±" }, { jcd: "19", name: "ä¸‹é–¢" }, { jcd: "20", name: "è‹¥æ¾" },
      { jcd: "21", name: "èŠ¦å±‹" }, { jcd: "22", name: "ç¦å²¡" }, { jcd: "23", name: "å”æ´¥" }, { jcd: "24", name: "å¤§æ‘" },
    ];

    const $grid = document.getElementById("grid");
    const $updatedAt = document.getElementById("updatedAt");
    const $btn = document.getElementById("btnRefresh");

    const $picks = document.getElementById("picks");
    const $picksUpdatedAt = document.getElementById("picksUpdatedAt");
    const $picksCta = document.getElementById("picksCta");

    const $btnPro = document.getElementById("btnPro");

    const pad2 = (n) => String(n).padStart(2, "0");
    const toHM = (s) => (typeof s === "string" && s.length >= 4) ? s.slice(0,5) : "--:--";

    // âœ… ã€Œ2 æ—¥ç›®ã€ã¿ãŸã„ãªä½™è¨ˆãªç©ºç™½ã‚’æ¶ˆã—ã¦ã€Œ2æ—¥ç›®ã€ã«ã™ã‚‹
    const normalizeJP = (s) => String(s || "").replace(/\s+/g, "");

    // âœ… gradeã®è¡¨è¨˜ãƒ–ãƒ¬ã‚’å¸åã—ã¦ SG/G1/G2/G3 ã ã‘é€šã™ï¼ˆãã‚Œä»¥å¤–ã¯ä¸€èˆ¬ï¼‰
    function normalizeGrade(raw){
      let s = String(raw || "").trim();

      // å…¨è§’â†’åŠè§’å¯„ã›ï¼ˆï¼§ï¼‘ãªã©ï¼‰
      s = s.replace(/[ï¼¡-ï¼ºï½-ï½šï¼-ï¼™]/g, ch =>
        String.fromCharCode(ch.charCodeAt(0) - 0xFEE0)
      );

      s = s.toUpperCase();
      s = s.replace(/\s+/g, "");

      // ãƒ­ãƒ¼ãƒæ•°å­—ç­‰ã®ãƒ–ãƒ¬å¸åï¼ˆGâ… , GI ãªã©ï¼‰
      s = s.replace("Gâ… ", "G1").replace("GI", "G1");
      s = s.replace("Gâ…¡", "G2").replace("GII", "G2");
      s = s.replace("Gâ…¢", "G3").replace("GIII", "G3");

      // æœ«å°¾ã«å¤‰ãªè¨˜å·ãŒã¤ãã‚±ãƒ¼ã‚¹ã‚’å‰Šã‚‹ï¼ˆä¾‹: "G1,"ï¼‰
      s = s.replace(/[^A-Z0-9]/g, "");

      if (s === "SG" || s === "G1" || s === "G2" || s === "G3") return s;
      return ""; // è¨˜å¿µã˜ã‚ƒãªã„æ‰±ã„
    }

    function gradeLabel(v){
      if (!v.held) return "";
      const g = normalizeGrade(v.grade);
      return g ? g : "ä¸€èˆ¬";
    }

    function dayLabel(v){
      if (!v.held) return "";
      if (typeof v.day === "number") return `${v.day}æ—¥ç›®`;
      if (typeof v.day === "string" && v.day.trim()) return normalizeJP(v.day.trim());
      return "â€”";
    }

    function raceTimeLine(v){
      if (!v.held) return "-- --";
      if (v.race && v.time) return `${String(v.race)} ${toHM(String(v.time))}`;
      if (v.next_r && v.close_at) return `${String(v.next_r)}R ${toHM(String(v.close_at))}`;
      return "-- --";
    }

    // âœ… è¿½åŠ ï¼šé–‹å‚¬åˆ¤å®šï¼ˆblocked ã§ã‚‚ bytes ã§åˆ¤å®šã™ã‚‹ï¼‰
    function inferHeld(v){
      if (v && v.held === true) return true;
      const sc = Number(v?.status_code || 0);
      const bytes = Number(v?.bytes || 0);
      if (sc === 200 && bytes >= 20000) return true;
      return false;
    }

    // =========================================================
    // âœ… ãƒ†ã‚¹ãƒˆè¡¨ç¤ºã‚¹ã‚¤ãƒƒãƒ
    //  - true : å…¨ä¼šå ´ã‚’ONæ‰±ã„ã«ã—ã¦ tone/è‰²åˆ†ã‘ã‚’ç¢ºèªã§ãã‚‹
    //  - false: å®Ÿãƒ‡ãƒ¼ã‚¿åˆ¤å®šã®ã¿ï¼ˆæœ¬ç•ªï¼‰
    // =========================================================
    const DEBUG_SHOW_TONES = true; // â† æœ¬ç•ªã¯ false ã«ã™ã‚‹

    // âœ… æ™‚åˆ»æ–‡å­—åˆ—ã‹ã‚‰ã€Œæ™‚ã€ã‚’æŠœãï¼ˆ"08:35" / "08:35:00" / "2026-.. 08:35" ã‚‚è¨±å®¹ï¼‰
    function getHourFromTimeStr(t){
      const s = String(t || "");
      const m = s.match(/(\d{2}):(\d{2})/);
      if (!m) return null;
      const hh = Number(m[1]);
      return Number.isFinite(hh) ? hh : null;
    }

    // âœ… toneåˆ¤å®šï¼šmorning / night / normal
    // ãƒ¢ãƒ¼ãƒ‹ãƒ³ã‚°ï¼š8ã€œ9æ™‚å°ï¼ˆ8:00ã€œ9:59ï¼‰
    // ãƒŠã‚¤ã‚¿ãƒ¼ï¼š17æ™‚ä»¥é™
    function sessionTone(v){
      if (!v.held) return "";
      const src = v.time || v.close_at || "";
      const hh = getHourFromTimeStr(src);
      if (hh === null) return "normal";
      if (hh >= 8 && hh < 10) return "morning";
      if (hh >= 17) return "night";
      return "normal";
    }

    // âœ… è¡¨ç¤ºã¯ã€Œçµµæ–‡å­—ã ã‘ã€ï¼šæœ/å¤œã®æ–‡å­—ã¯å‡ºã•ãªã„
    function sessionIconByTone(tone){
      if (tone === "morning") return "â˜€ï¸";
      if (tone === "night") return "ğŸŒ™";
      return ""; // normal ã¯ä½•ã‚‚å‡ºã•ãªã„ï¼ˆè‰²ã ã‘ã§åˆ¤åˆ¥ï¼‰
    }

    // âœ… DEBUGç”¨ï¼šå…¨ä¼šå ´ã«3ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ•£ã‚‰ã™ï¼ˆmorning/night/normalï¼‰
    function debugToneByIndex(i){
      const m = i % 3;
      if (m === 0) return "morning";
      if (m === 1) return "night";
      return "normal";
    }

    function cardHTML(v){
      const held = !!v.held;

      // âœ… DEBUGä¸­ã¯èª¤ã‚¿ãƒƒãƒ—é˜²æ­¢ã§ãƒªãƒ³ã‚¯ç„¡åŠ¹åŒ–ï¼ˆæœ¬ç•ªã¯URLã‚ã‚‹ä¼šå ´ã ã‘æœ‰åŠ¹ï¼‰
      const href = (held && v.url && !DEBUG_SHOW_TONES) ? v.url : "#";
      const clickable = (held && v.url && !DEBUG_SHOW_TONES);

      const tone = held ? (v.tone || "normal") : "";
      const toneCls = held ? ` card--tone-${tone}` : "";
      const cls = held ? `card card--on${toneCls}` : `card card--off`;

      const icon = held ? sessionIconByTone(tone) : "";
      const baseMid = held ? `${gradeLabel(v)} ${dayLabel(v)}`.trim() : "-- --";
      const mid = held ? `${icon ? (icon + " ") : ""}${baseMid}`.trim() : "-- --";

      const btm = raceTimeLine(v);

      return `
        <a class="${cls}" href="${href}" data-tone="${tone}"
           ${clickable ? "" : 'aria-disabled="true" onclick="return false;"'}>
          <div class="card__name">${v.name}</div>
          <div class="card__line card__line--mid">${mid}</div>
          <div class="card__line card__line--btm">${btm}</div>
        </a>
      `;
    }

    function render(data){
      const map = new Map();
      (data.venues || []).forEach(v => map.set(v.jcd, v));

      const merged = VENUES.map((base, idx) => {
        const v = map.get(base.jcd) || {};

        // âœ… heldï¼ˆDEBUGãªã‚‰å…¨ä¼šå ´ONï¼‰
        const held = DEBUG_SHOW_TONES ? true : inferHeld(v);

        const mergedV = {
          jcd: base.jcd,
          name: base.name,
          url: v.url || "",
          held: held,
          grade: v.grade,
          day: v.day,
          race: v.race,
          time: v.time,
          next_r: v.next_r,
          close_at: v.close_at,
          status_code: v.status_code,
          bytes: v.bytes,
          note: v.note
        };

        // âœ… toneç¢ºå®š
        mergedV.tone = held
          ? (DEBUG_SHOW_TONES ? debugToneByIndex(idx) : sessionTone(mergedV))
          : "";

        return mergedV;
      });

      $grid.innerHTML = merged.map(cardHTML).join("");

      if (data.time) {
        const t = String(data.time);
        const hm = t.includes(" ") ? t.split(" ")[1].slice(0,5) : "--:--";
        $updatedAt.textContent = hm;
      } else {
        const now = new Date();
        $updatedAt.textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
      }
    }

    // ====== picks_today.json ======
    function gradeBadgeClass(g){
      const ng = normalizeGrade(g);
      if (ng === "SG") return "badge badge--sg";
      if (ng === "G1") return "badge badge--g1";
      if (ng === "G2") return "badge badge--g2";
      if (ng === "G3") return "badge badge--g3";
      return "badge badge--ippan";
    }

    function pickCardHTML(p){
      const venue = p.venue || (p.jcd ? (VENUES.find(v => v.jcd === p.jcd)?.name || "") : "");
      const race = p.race ? String(p.race) : "";
      const tm = p.time ? toHM(String(p.time)) : "--:--";
      const title = p.title ? String(p.title) : "å³é¸";
      const g = p.grade ? String(p.grade) : "ä¸€èˆ¬";
      const note = p.note ? String(p.note) : "";
      const href = p.url ? String(p.url) : "#";
      const clickable = !!p.url;

      return `
        <a class="pickCard" href="${href}" ${clickable ? "" : 'aria-disabled="true" onclick="return false;"'}>
          <div class="pickTop">
            <div class="pickName">${venue} ${race} <span style="opacity:.7;font-weight:700">ï¼ ${title}</span></div>
            <div class="pickTime">${tm}</div>
          </div>
          <div class="pickSub">
            <span class="${gradeBadgeClass(g)}">${normalizeGrade(g) || "ä¸€èˆ¬"}</span>
            ${p.tag ? `<span class="badge">${String(p.tag)}</span>` : ""}
          </div>
          ${note ? `<p class="pickNote">${note}</p>` : ``}
        </a>
      `;
    }

    function renderPicks(data){
      const picks = Array.isArray(data?.picks) ? data.picks : [];

      if (!picks.length){
        $picks.innerHTML = "";
      } else {
        $picks.innerHTML = picks.map(pickCardHTML).join("");
      }

      if (data?.time) {
        const t = String(data.time);
        const hm = t.includes(" ") ? t.split(" ")[1].slice(0,5) : "--:--";
        $picksUpdatedAt.textContent = hm;
      } else {
        const now = new Date();
        $picksUpdatedAt.textContent = `${pad2(now.getHours())}:${pad2(now.getMinutes())}`;
      }
    }

    // ====== âœ… CTAï¼ˆFREEã¯3ã¤ / PROã¯åˆ¥æ ï¼‰ ======
    const URL_YOSO_ONLY = "https://note.com/wsnndboat7/n/n1fdca8b0a7e3";
    const URL_PRO_ONLY  = "https://note.com/wsnndboat7/n/n8d805a4f27bf";
    const URL_SET       = "https://note.com/wsnndboat7/n/n6fcdb2a9db4f";

    function renderPicksCta(){
      const isPro = document.documentElement.getAttribute("data-theme") === "pro";

      if (!isPro){
        $picksCta.innerHTML = `
          <a class="picksBtn" href="${URL_YOSO_ONLY}" target="_blank" rel="noopener noreferrer">
            <div>
              <div>äºˆæƒ³ã ã‘è³¼å…¥ï¼ˆ500å††ï¼‰</div>
              <div class="picksBtnSub">noteã§ç¢ºèª</div>
            </div>
            <div class="picksBtnArrow">â†’</div>
          </a>

          <a class="picksBtn" href="${URL_PRO_ONLY}" target="_blank" rel="noopener noreferrer">
            <div>
              <div>PROã ã‘è³¼å…¥ï¼ˆ500å††ï¼‰</div>
              <div class="picksBtnSub">ã‚­ãƒ¼é…å¸ƒæ–¹å¼ï¼ˆè³¼èª­è€…ï¼PROæ‰±ã„ï¼‰</div>
            </div>
            <div class="picksBtnArrow">â†’</div>
          </a>

          <a class="picksBtn picksBtn--set" href="${URL_SET}" target="_blank" rel="noopener noreferrer">
            <div>
              <div>ã‚»ãƒƒãƒˆè³¼å…¥ï¼ˆ800å††ï¼‰</div>
              <div class="picksBtnSub">äºˆæƒ³ + PROï¼ˆãŠå¾—ï¼‰</div>
            </div>
            <div class="picksBtnArrow">â†’</div>
          </a>
        `;
        return;
      }

      $picksCta.innerHTML = `
        <a class="picksBtn" href="#" aria-disabled="true" onclick="return false;">
          <div>
            <div>æœ¬æ—¥ã®æ³¨ç›®é¸æ‰‹ï¼ˆPROï¼‰</div>
            <div class="picksBtnSub">ã“ã“ã¯å¾Œã§å·®ã—æ›¿ãˆ</div>
          </div>
          <div class="picksBtnArrow">â€”</div>
        </a>

        <a class="picksBtn" href="#" aria-disabled="true" onclick="return false;">
          <div>
            <div>æœ¬æ—¥ã®æ³¨ç›®æ©Ÿï¼ˆPROï¼‰</div>
            <div class="picksBtnSub">ã“ã“ã¯å¾Œã§å·®ã—æ›¿ãˆ</div>
          </div>
          <div class="picksBtnArrow">â€”</div>
        </a>
      `;
    }

    // âœ… 24ä¼šå ´ã‚’ã€Œç”»é¢å†…ã«åã‚ã‚‹ã€é«˜ã•è¨ˆç®—ï¼ˆã‚°ãƒªãƒƒãƒ‰æ¯”ç‡ã¯å›ºå®šã®ã¾ã¾ï¼‰
    function setGridHeight(){
      const root = document.documentElement;
      const vv = window.visualViewport;
      const vh = vv ? vv.height : window.innerHeight;

      const header = document.querySelector(".top");
      const headerH = header ? header.getBoundingClientRect().height : 0;

      const margin = 18;
      const bottomReserve = 110;

      const gridH = Math.max(360, Math.floor(vh - headerH - margin - bottomReserve));
      root.style.setProperty("--gridH", `${gridH}px`);
    }

    // ====== æ›´æ–°ï¼ˆé‡è¤‡é˜²æ­¢ + ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ï¼‰ ======
    let isLoading = false;

    async function fetchJSON(path, force){
      const bust = force ? `?t=${Date.now()}` : "";
      const url = `${path}${bust}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`failed to fetch: ${path}`);
      return await res.json();
    }

    async function loadAll(force){
      if (isLoading) return;
      isLoading = true;
      try{
        const venuesData = await fetchJSON("./data/venues_today.json", force);
        render(venuesData);

        try{
          const picksData = await fetchJSON("./data/picks_today.json", force);
          renderPicks(picksData);
        }catch(e){
          renderPicks({ time: null, picks: [] });
        }

        renderPicksCta();
        setGridHeight();
      }finally{
        isLoading = false;
      }
    }

    $btn.addEventListener("click", () => {
      $btn.classList.add("is-loading");
      loadAll(true).catch(()=>{}).finally(()=> $btn.classList.remove("is-loading"));
    });

    // pull-to-refreshï¼ˆç°¡æ˜“ï¼‰
    let startY = 0;
    let pulling = false;

    window.addEventListener("touchstart", (e) => {
      if (window.scrollY <= 0) { startY = e.touches[0].clientY; pulling = true; }
    }, { passive: true });

    window.addEventListener("touchmove", (e) => {
      if (!pulling) return;
      const dy = e.touches[0].clientY - startY;
      if (dy > 80) { pulling = false; $btn.click(); }
    }, { passive: true });

    window.addEventListener("touchend", () => { pulling = false; }, { passive: true });

    // viewportå¤‰åŒ–ã«ã‚‚è¿½å¾“
    window.addEventListener("resize", setGridHeight);
    if (window.visualViewport) window.visualViewport.addEventListener("resize", setGridHeight);

    // âœ… 5åˆ†ã”ã¨ã®è‡ªå‹•æ›´æ–°ï¼ˆè¡¨ç¤ºä¸­ã ã‘ï¼‰
    const AUTO_MS = 5 * 60 * 1000;
    setInterval(() => {
      if (document.visibilityState === "visible") loadAll(true).catch(()=>{});
    }, AUTO_MS);

    document.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "visible") loadAll(true).catch(()=>{});
    });

    // ====== âœ… PRO è§£æ”¾ï¼ˆ1æ—¥å›ºå®š / data/pro_key.json ã‚’ç…§åˆï¼‰ ======
    const LS_THEME = "theme";
    const LS_PRO_OK_DATE = "pro_ok_date";

    function isProNow(){
      return document.documentElement.getAttribute("data-theme") === "pro";
    }

    function setTheme(isPro){
      const html = document.documentElement;
      if (isPro){
        html.setAttribute("data-theme","pro");
        localStorage.setItem(LS_THEME,"pro");
        $btnPro.setAttribute("aria-pressed","true");
      }else{
        html.removeAttribute("data-theme"); // FREE
        localStorage.setItem(LS_THEME,"free");
        $btnPro.setAttribute("aria-pressed","false");
      }
      renderPicksCta();
      setGridHeight();
    }

    async function getProKey(){
      return await fetchJSON("./data/pro_key.json", true);
    }

    async function bootProByStoredDate(){
      const savedTheme = localStorage.getItem(LS_THEME);
      const savedOkDate = localStorage.getItem(LS_PRO_OK_DATE);

      if (savedTheme !== "pro" || !savedOkDate){
        setTheme(false);
        return;
      }

      try{
        const pk = await getProKey();
        if (String(pk?.date || "") === String(savedOkDate)){
          setTheme(true);
        }else{
          localStorage.removeItem(LS_PRO_OK_DATE);
          setTheme(false);
        }
      }catch(e){
        setTheme(false);
      }
    }

    async function unlockProFlow(){
      if (isProNow()){
        setTheme(false);
        return;
      }

      let pk;
      try{
        pk = await getProKey();
      }catch(e){
        alert("PROã‚­ãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚é€šä¿¡çŠ¶æ³ã‚’ç¢ºèªã—ã¦ã€ã‚‚ã†ä¸€åº¦ãŠè©¦ã—ãã ã•ã„ã€‚");
        return;
      }

      const input = prompt("PROã‚­ãƒ¼ï¼ˆ6æ¡ï¼‰ã‚’å…¥åŠ›");
      if (input === null) return;

      const key = String(input).replace(/\s+/g,"");
      if (!/^\d{6}$/.test(key)){
        alert("6æ¡ã®æ•°å­—ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚");
        return;
      }

      if (String(pk?.key || "") === key){
        localStorage.setItem(LS_PRO_OK_DATE, String(pk.date || ""));
        setTheme(true);
        alert("PROã‚’è§£æ”¾ã—ã¾ã—ãŸã€‚");
      }else{
        alert("ã‚­ãƒ¼ãŒé•ã„ã¾ã™ã€‚");
      }
    }

    $btnPro.addEventListener("click", () => {
      unlockProFlow().catch(()=>{});
    });

    bootProByStoredDate().catch(()=> setTheme(false));

    // åˆå›
    loadAll(false).catch(()=>{ renderPicksCta(); setGridHeight(); });
  </script>
</body>
</html>